@(datasets: Page[(Dataset, Seq[DatasetDumpfile])])(implicit flash: Flash, s: play.api.db.slick.Config.driver.simple.Session)
<html>
  <head>
    <title>Pelagios API » Admin » Datasets</title>
    <script type="text/javascript" src="@routes.Assets.at("javascripts/lib/jquery-1.9.0.min.js")"></script>
    <script type="text/javascript" src="@routes.Assets.at("javascripts/admin-utils.js")"></script>
    <link rel="stylesheet" href="@routes.Assets.at("stylesheets/admin/main.css")" />
    <script type="text/javascript">
      function deleteDataset(id) {
        $.ajax({
          type: 'DELETE',
          url: '@controllers.admin.routes.DatasetAdminController.index/' + id,
          success: function(result) { location.href = '@controllers.admin.routes.DatasetAdminController.index'; },
          error: function(result) { console.log(result); }
        });
      }
      
      function harvestDataset(id) {
        $.ajax({
          type: 'POST',
          url: '@controllers.admin.routes.DatasetAdminController.index/' + id + '/harvests',
          success: function(result) { location.href = '@controllers.admin.routes.DatasetAdminController.index'; },
          error: function(result) { console.log(result); }
        });
	  }

      function toggleSubsets(id) {
        var tbody = $('table.list').find('tbody');
        
        var toggleIcon = $('.plus-' + id);
        toggleIcon.toggleClass('less');
        
        // Bit hacky in the sense that we're pulling this via the API in two steps & order is not maintained.
        // But OK for the admin UI
        $.getJSON('@controllers.routes.DatasetController.listAll()/' + id, function(dataset) {
          if (dataset.subsets) {
            $.each(dataset.subsets, function(idx, subsetNameAndId) {
              $.getJSON('@controllers.routes.DatasetController.listAll()/' + subsetNameAndId.id, function(subset) {
				var harvest = (subset.dumpfiles) ? '<button class="small harvest" onclick="harvestDataset(\'' + subset.id + '\');">Harvest (' + subset.dumpfiles.length + ')</button>' : '';
                var html = 
                  $('<tr>' +
                    '  <td></td>' +
                    '  <td>' + subset.id.substr(0, 8) + '...</td>' +
                    '  <td>&raquo; ' + subset.title + '</td>' +
                    '  <td></td>' +
                    '  <td></td>' +
                    '  <td></td>' +
                    '  <td></td>' +
                    '  <td></td>' +
                    '  <td>' + harvest + '</td>' +
                    '  <td class="right">' + 
                    '    <button class="button upload small" data-input="import-annotations-' + subset.id + '">' +
                    '      <span class="icon">&#xf016;</span>&nbsp; Import File' +
                    '    </button>' +
                    '    <button class="button small red" title="Drop Dataset"><span class="icon">&#xf05e;</span></button>' +
                    '    <form method="POST" enctype="multipart/form-data">' +
                    '      <input type="file" id="import-annotations-' + subset.id + '" name="annotations">' +
                    '    </form>' +
                    '  </td>' +
                    '</tr>');
                  
                // Set POST destination URL
                var form = html.find('form')[0];
                form.action = '@controllers.admin.routes.DatasetAdminController.index/' + subset.id + '/annotations';
                tbody.append(html);
              });
            });
          }
        });
      }
    </script>
  </head>
  
  <body>
    <div id="content">    
      @flash.get("error").map { message =>
        <h2>Something's wrong with your uploaded file.</h2>
        <div class="error">@Html(message)</div>
      }
      
      @flash.get("success").map { message =>
        <div class="success">@message</div>
      }
      
      <div id="admin-actions">
        <button class="button big upload icon" data-input="upload-void">&#xf093;</button>
        <h4>Upload VoID Dataset Description</h4>
      </div>
    
      @helper.form(action = controllers.admin.routes.DatasetAdminController.uploadDataset(), 'enctype -> "multipart/form-data") {
        <input type="file" id="upload-void" name="void">
      }
      
      <table class="list">
        <thead>
          <tr>
            <th></th>
            <th>ID</th>
            <th>Title</th>
            <th>Publisher</th>
            <th>Created</th>
            <th>Modified</th>
            <th>Annotations</th>
            <th>VoID</th>
            <th>Dump Files</th>
            <th></th> <!-- Actions -->
          </tr>
        </thead>
        <tbody>
          @for((dataset, dumpfiles) <- datasets.items) {
          	<tr>
              @if(models.Datasets.listSubsets(dataset.id).size > 0) {
          	    <td class="icon plus plus-@dataset.id" onclick="toggleSubsets('@dataset.id'); return false;"></td>  
          	  } else {
          	    <td class="icon"></td>
          	  }
          	  </td>
          	  <td><a href="@routes.DatasetController.get(dataset.id)">@{dataset.id.substring(0, 8)}...</a></td>
              <td>@dataset.title</td>
              <td>@dataset.publisher</td>
              <td>@dataset.created</td>
              <td>@dataset.modified</td>
              <td class="center">@Annotations.countByDataset(dataset.id)</td>
              <td>
                @if(dataset.voidURI.isDefined) {                	
                  <a class="icon" href="@dataset.voidURI.get">&#xf0c1;</a>
                }
              </td>
              <td>
                <!-- dumpfiles -->
              </td>
              <td class="right">
                <button class="button upload small" data-input="import-annotations-@dataset.id"><span class="icon">&#xf016;</span>&nbsp; Import File</button>
                <button class="button small red" onclick="deleteDataset('@dataset.id');" title="Drop Dataset"><span class="icon">&#xf05e;</span></button>
                
		        @helper.form(action = controllers.admin.routes.DatasetAdminController.uploadAnnotations(dataset.id), 'enctype -> "multipart/form-data") {
                  <input type="file" id="import-annotations-@dataset.id" name="annotations">
                }
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
    <script>
      (function() {
        util.enableUploads();
      })();
    </script>
  </body>
</html>
