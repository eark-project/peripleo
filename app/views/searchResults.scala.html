@(results: Page[index.objects.IndexedObject], took: Long)(implicit s: play.api.db.slick.Config.driver.simple.Session)
<html>
  <head>
    <link rel="stylesheet" href="@routes.Assets.at("stylesheets/home/searchresults.css")"/>
    <link rel="stylesheet" href="@routes.Assets.at("javascripts/lib/leaflet/leaflet.css")"/>
    <script type="text/javascript" src="@routes.Assets.at("javascripts/lib/jquery-1.9.0.min.js")"></script>
    <script type="text/javascript" src="@routes.Assets.at("javascripts/lib/jquery.twbsPagination.min.js")"></script>
    <script type="text/javascript" src="@routes.Assets.at("javascripts/lib/numeral.min.js")"></script>
    <script type="text/javascript" src="@routes.Assets.at("javascripts/page-utils.js")"></script>
    <script type="text/javascript" src="@routes.Assets.at("javascripts/lib/leaflet/leaflet.js")"></script>
    <script type="text/javascript" src="@routes.Assets.at("javascripts/lib/leaflet/leaflet-heat.js")"></script>
  </head>
  <body>
    <div id="header">
      <div id="header-menu">
        <div class="row">
          <a class="pelagios-logo" href="@controllers.pages.routes.HomepageController.index">PELAGIOS API</a>
          <ul>
            <li><a href="@controllers.pages.routes.HomepageController.index">Home</a></li>
            <li><a href="@controllers.pages.routes.DatasetPagesController.listAll">Datasets</a></li>
            <li><a href="#">Places</a></li>
          </ul>
        </div> <!-- .row -->
      </div> <!-- #header-menu -->
      
      <div id="header-body">
        <div class="row">
          <em class="number">@results.total</em> results for <span class="query">@results.query</span> (took @{ took.toDouble / 1000 }s)
        </div>
      </div>
    </div> <!-- #header -->
    
    <div id="content">
      <div class="row pagination">
        <span class="label">Showing Results <strong>@{results.offset + 1}</strong> to <strong>@{ Math.min(results.total, results.offset + results.limit) }</strong></span>
        <ul></ul>
      </div>
      
      <div class="row">
        <div class="sidebar">
          <div id="map"></div>
        </div>
      
        <ul id="results">
          @for(item <- results.items) {
          	@tags.searchresultItem(item)
          }
        </ul>
      </div> <!-- .row -->
    </div> <!-- #content -->
    
    <script>
      var totalPages = @{ Math.ceil(results.total.toDouble / results.limit) };
      
      $('.pagination ul').twbsPagination({
        totalPages: totalPages,
        startPage: @{ Math.ceil(results.offset.toDouble / results.limit) + 1 }, 
        first: '&#xf100;',
        prev: '&#xf104;',
        next: '&#xf105;',
        last: '&#xf101;',
        onPageClick: function (event, page) {
          var offset = (page - 1) * @results.limit;
          $('#results').html('');
          location.search = util.buildPageRequestURL(offset, @results.limit);
        }
      });
      
      util.formatNumbers();
      
      jQuery(document).ready(function() {
        // Quick hack        
        var awmcLayer = L.tileLayer('http://a.tiles.mapbox.com/v3/isawnyu.map-knmctlkh/{z}/{x}/{y}.png', {
              attribution: 'Data &copy; <a href="http://www.awmc.unc.edu" target="_blank">AWMC</a> ' +
                           '<a href="http://creativecommons.org/licenses/by-nc/3.0/deed.en_US" target="_blank">CC-BY-NC</a>'}),
                           
            map = new L.Map('map', {
              center: new L.LatLng(41.893588, 12.488022),
              zoom: 3,
              layers: [awmcLayer]
            });
        
        var loadNextBatch = function(offset, limit) {
          var search = util.buildPageRequestURL(offset, limit);
          var points = [];
          jQuery.getJSON('@{controllers.pages.routes.HomepageController.index}search?' + search, function(data) {
            jQuery.each(data.items, function(idx, result) {
              if (result.geo_bounds) {
                points.push([(result.geo_bounds.min_lat + result.geo_bounds.max_lat) / 2, (result.geo_bounds.min_lon + result.geo_bounds.max_lon) / 2]);
              }
            });
            L.heatLayer(points, { max: 1.5, maxZoom: 3, radius: 4, blur: 6 }).addTo(map);
          });
        };
      
        
        var bounds = [
          @results.items.flatMap(_.convexHull).map(cv => { 
            val b = cv.bounds 
            "L.latLngBounds([" + b.minLat + "," + b.minLon + "], [" + b.maxLat + "," + b.maxLon + "])"
          }).mkString(",\n")
        ];
        
        var envelope = L.latLngBounds(bounds);
        if (envelope.isValid())
          map.fitBounds(envelope, {padding: [50, 50]});
        
        jQuery.each(bounds, function(idx, b) {
          L.marker(b.getCenter()).addTo(map);
        }); 
        
        loadNextBatch(0, 10000);
      });
    </script>
  </body>
</html>
