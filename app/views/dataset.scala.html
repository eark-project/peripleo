@(dataset: Dataset, things: Int, places: Int, annotations: Int)
<html>
  <head>
    <title>Dataset &raquo; @dataset.title</title>
    <link rel="stylesheet" href="@routes.Assets.at("stylesheets/datasets/main.css")"/>   
    <link rel="stylesheet" href="@routes.Assets.at("javascripts/lib/leaflet/leaflet.css")"/>
    <script type="text/javascript" src="@routes.Assets.at("javascripts/lib/jquery-1.9.0.min.js")"></script>
    <script type="text/javascript" src="@routes.Assets.at("javascripts/lib/leaflet/leaflet.js")"></script>
    <script type="text/javascript" src="@routes.Assets.at("javascripts/lib/leaflet/leaflet-heat.js")"></script>
    <script type="text/javascript" src="@routes.Assets.at("javascripts/lib/numeral.min.js")"></script>
    <script type="text/javascript" src="@routes.Assets.at("javascripts/lib/jquery.simplePagination.js")"></script>
    <script type="text/javascript" src="@routes.Assets.at("javascripts/heatmap.js")"></script>
  </head>
  <body>
    <div id="header">
      <div id="header-menu">
        <div class="row">
          <span class="pelagios-logo">PELAGIOS API</span> 
          <ul>
            <li><a href="#">Home</a></li>
            <li><a href="#">Datasets</a></li>
            <li><a href="#">Places</a></li>
          </ul>
        </div>
      </div>
      
      <div id="header-body">
        <div class="row">
          <h1>@dataset.title</h1>
          <h2>
            @if(dataset.homepage.isDefined) {
              by <a href="@dataset.homepage.get">@dataset.publisher</a>
            } else {
              by @dataset.publisher 
            }
          </h2>
          @dataset.description.map { description => <p class="description">@description</p> }
          <p class="stats">
            <span><em class="number">@things</em> items with</span>
            <span><em class="number">@annotations</em> references to</span>
            <span><em class="number">@places</em> unique places</span>
          </p>
        </div>
      </div>
    </div>
    
    <div id="content">
      <div class="row"><h2>Most Frequently Referenced Places</h2></div>
      <div class="row">
        <div id="map"></div>
        <table id="top-n-places"></table>
      </div>
      
      <div class="row" id="items-list">
        <h2>Items in this Dataset</h2>
        <div class="pagination"></div>
        <table>
          <thead>
            <tr>
              <th class="left">Title</th>
              <th class="center">Place References</th>
              <th class="center">Unique Places</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
    </div>
    
    <script>
    (function() {      
      var maxReferences,
          meterTemplate = 
            '<tr>' +
            '  <td class="place-title">@@title@@</td>' +
            '  <td class="place-count">' +
            '    <div class="meter">' +
            '      <div class="bar" style="width:@@width@@%;"></div><span>@@occurrences@@</span>' +
            '    </div>' +
            '  </td>'+ 
            '</tr>';
            
      // Helper function to show the next N places in the 'top places' list
      var showNext = function(places, shown, n) {
        for (var i=shown, j=shown + n; i<j; i++) {
          var occurrences = places[i].number_of_occurrences;
          var html = meterTemplate
            .replace('@@title@@', places[i].title)
            .replace('@@width@@', (occurrences / maxReferences) * 100)
            .replace('@@occurrences@@', occurrences);
          $('#top-n-places').append(html);
        }
      };
      
      // Helper function to load a page of items
      var loadItems = function(offset, pagesize, callback) {
        $.getJSON('@routes.DatasetController.listAnnotatedThings(dataset.id, None, None, None)?offset=' + offset + '&limit=' + pagesize, function(data) {
          var table = $('#items-list table tbody');
          $.each(data.items, function(idx, item) {
            console.log(item);
            table.append('<tr>' + 
                           '<td>' + item.title + '</td>' +
                           '<td class="center">' + item.number_of_annotations + '</td>' +
                           '<td class="center">' + item.number_of_unique_places + '</td>' +
                         '</tr>');
          });
          callback(data);
        });        
      };      
                  
      // Format numbers
      $.each($('.number'), function(idx, el) {
        var formatted = numeral($(el).text()).format('0,0');
        $(el).html(formatted);
      }); 

      // Load items
      loadItems(0, 20, function(data) {
        $('.pagination').pagination({
          items: data.total,
          itemsOnPage: 20,
          hrefTextPrefix: '#item-page-',
          onPageClick: function(pageNumber, event) {
            // TODO load next
          }
        })
      });
      
      // Load places
      $.getJSON('@routes.DatasetController.listPlaces(dataset.id, Some(0), Some(Int.MaxValue), None)', function(data) {
        maxReferences = data.items[0].number_of_occurrences;
        
        // List top 5 places
        showNext(data.items, 0, 8);
        
        // Draw heatmap
        var heatmap = new Heatmap('map', data.items);
      });
    })();
    </script>
  </body>
</html>
